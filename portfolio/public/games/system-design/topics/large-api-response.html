<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Large API Response 處理策略</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang HK", "Microsoft JhengHei", sans-serif; background: #0f1117; color: #e0e0e0; min-height: 100vh; }
    .container { max-width: 960px; margin: 0 auto; padding: 40px 24px; }
    header { text-align: center; margin-bottom: 40px; }
    header h1 { font-size: 2rem; font-weight: 700; color: #ffffff; margin-bottom: 8px; }
    header p { font-size: 1rem; color: #9ca3af; line-height: 1.6; }
    .card { background: #1a1d27; border-radius: 16px; padding: 32px; margin-bottom: 24px; border: 1px solid #2a2d3a; }
    .card h2 { font-size: 1.5rem; color: #ffffff; margin-bottom: 8px; }
    .card .subtitle { font-size: 0.95rem; color: #6366f1; font-weight: 500; margin-bottom: 16px; }
    .card p { font-size: 0.95rem; color: #c0c4cc; line-height: 1.8; margin-bottom: 12px; }
    .diagram-container { background: #13151c; border-radius: 12px; padding: 24px; margin: 24px 0; overflow-x: auto; border: 1px solid #2a2d3a; }
    .diagram-container svg { display: block; margin: 0 auto; max-width: 100%; height: auto; }
    .steps { list-style: none; padding: 0; margin: 16px 0; }
    .steps li { display: flex; align-items: flex-start; gap: 12px; padding: 12px 0; border-bottom: 1px solid #2a2d3a; font-size: 0.95rem; color: #c0c4cc; line-height: 1.6; }
    .steps li:last-child { border-bottom: none; }
    .step-num { flex-shrink: 0; width: 28px; height: 28px; border-radius: 50%; background: #6366f1; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; }
    .key-points { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
    @media (max-width: 600px) { .key-points { grid-template-columns: 1fr; } .container { padding: 24px 16px; } header h1 { font-size: 1.5rem; } .card { padding: 20px; } }
    .key-point { background: #13151c; border-radius: 10px; padding: 16px; border-left: 3px solid #6366f1; }
    .key-point h4 { color: #a5b4fc; font-size: 0.9rem; margin-bottom: 6px; }
    .key-point p { font-size: 0.85rem; color: #c0c4cc; margin-bottom: 0; line-height: 1.6; }
    .use-case { background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.05)); border-left: 3px solid #6366f1; border-radius: 0 10px 10px 0; padding: 16px 20px; margin-top: 16px; }
    .use-case h4 { color: #a5b4fc; font-size: 0.9rem; margin-bottom: 6px; }
    .use-case p { font-size: 0.9rem; color: #c0c4cc; margin-bottom: 0; }
    .tabs { display: flex; gap: 4px; background: #1a1d27; border-radius: 12px; padding: 4px; margin-bottom: 24px; overflow-x: auto; }
    .tab-btn { flex: 1; padding: 12px 16px; border: none; background: transparent; color: #9ca3af; font-size: 0.9rem; font-weight: 500; border-radius: 8px; cursor: pointer; transition: all 0.25s ease; white-space: nowrap; font-family: inherit; }
    .tab-btn:hover { color: #e0e0e0; background: rgba(255, 255, 255, 0.05); }
    .tab-btn.active { background: #6366f1; color: #ffffff; font-weight: 600; }
    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Large API Response 處理策略</h1>
      <p>當 API 需要回傳大量數據，點樣有效咁處理同優化回應</p>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="pagination">① 分頁處理</button>
      <button class="tab-btn" data-tab="compression">② 數據壓縮</button>
      <button class="tab-btn" data-tab="offload">③ S3 卸載</button>
    </div>

    <!-- ==================== TAB 1: PAGINATION ==================== -->
    <div id="pagination" class="tab-content active">
      <div class="card">
        <h2>Pagination 分頁處理</h2>
        <div class="subtitle">將大量數據拆成細份，每次只回傳一頁</div>
        <p>
          概念好簡單 — 就好似 Google 搜尋結果咁，唔會一次過顯示幾百萬個結果，而係每頁只顯示 10 條。
          API 都係一樣，當有大量 record 需要回傳嘅時候，最常見嘅做法係用 Pagination 將數據切開，
          每次 request 只回傳指定數量嘅資料。
        </p>
        <p>
          重點係：唔好一次過 load 晒所有嘢。每個 page 只包含固定數量嘅 item（例如 20 條），
          client 需要更多就再 request 下一頁。咁樣可以大幅減少每次 response 嘅 payload size，
          亦都降低 server 同 database 嘅壓力。
        </p>

        <div class="diagram-container">
          <svg viewBox="0 0 700 340" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="pg-client-grad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#6366f1" stop-opacity="0.4"/>
                <stop offset="100%" stop-color="#1e293b"/>
              </linearGradient>
              <linearGradient id="pg-server-grad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#10B981" stop-opacity="0.4"/>
                <stop offset="100%" stop-color="#1e293b"/>
              </linearGradient>
              <linearGradient id="pg-db-grad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#f59e0b" stop-opacity="0.4"/>
                <stop offset="100%" stop-color="#1e293b"/>
              </linearGradient>
              <linearGradient id="pg-page-grad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#a5b4fc" stop-opacity="0.3"/>
                <stop offset="100%" stop-color="#1e293b"/>
              </linearGradient>
              <filter id="pg-glow">
                <feGaussianBlur stdDeviation="4" result="blur"/>
                <feFlood flood-color="#6366f1" flood-opacity="0.4" result="color"/>
                <feComposite in="color" in2="blur" operator="in" result="glow"/>
                <feMerge>
                  <feMergeNode in="glow"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
              <filter id="pg-shadow">
                <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.4"/>
              </filter>
              <marker id="pg-arrow-blue" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
                <polygon points="0 0, 10 3.5, 0 7" fill="#6366f1"/>
              </marker>
              <marker id="pg-arrow-green" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
                <polygon points="0 0, 10 3.5, 0 7" fill="#34d399"/>
              </marker>
            </defs>

            <!-- Client -->
            <rect x="30" y="50" width="130" height="56" rx="14" fill="url(#pg-client-grad)" stroke="#6366f1" stroke-width="1.5" filter="url(#pg-glow)"/>
            <text x="95" y="83" text-anchor="middle" fill="#e0e0e0" font-size="14" font-weight="600">Client</text>

            <!-- API Server -->
            <rect x="280" y="50" width="140" height="56" rx="14" fill="url(#pg-server-grad)" stroke="#10B981" stroke-width="1.5" filter="url(#pg-shadow)"/>
            <text x="350" y="83" text-anchor="middle" fill="#e0e0e0" font-size="14" font-weight="600">API Server</text>

            <!-- Database -->
            <rect x="540" y="50" width="130" height="56" rx="14" fill="url(#pg-db-grad)" stroke="#f59e0b" stroke-width="1.5" filter="url(#pg-shadow)"/>
            <text x="605" y="83" text-anchor="middle" fill="#e0e0e0" font-size="14" font-weight="600">Database</text>

            <!-- Arrow: Client -> Server -->
            <path d="M160,70 C210,70 230,70 278,70" stroke="#6366f1" stroke-width="1.8" fill="none" marker-end="url(#pg-arrow-blue)"/>
            <text x="219" y="62" text-anchor="middle" fill="#9ca3af" font-size="11">GET /items?page=1</text>

            <!-- Arrow: Server -> DB -->
            <path d="M420,78 C470,78 490,78 538,78" stroke="#f59e0b" stroke-width="1.8" fill="none" marker-end="url(#pg-arrow-blue)"/>
            <text x="479" y="70" text-anchor="middle" fill="#9ca3af" font-size="11">LIMIT 20 OFFSET 0</text>

            <!-- Page results -->
            <rect x="170" y="160" width="120" height="48" rx="14" fill="url(#pg-page-grad)" stroke="#a5b4fc" stroke-width="1" filter="url(#pg-shadow)"/>
            <text x="230" y="188" text-anchor="middle" fill="#a5b4fc" font-size="12" font-weight="600">Page 1 (1-20)</text>

            <rect x="310" y="160" width="120" height="48" rx="14" fill="url(#pg-page-grad)" stroke="#a5b4fc" stroke-width="1" filter="url(#pg-shadow)"/>
            <text x="370" y="188" text-anchor="middle" fill="#a5b4fc" font-size="12" font-weight="600">Page 2 (21-40)</text>

            <rect x="450" y="160" width="120" height="48" rx="14" fill="url(#pg-page-grad)" stroke="#a5b4fc" stroke-width="1" filter="url(#pg-shadow)"/>
            <text x="510" y="188" text-anchor="middle" fill="#a5b4fc" font-size="12" font-weight="600">Page 3 (41-60)</text>

            <!-- Arrow: Server down to pages -->
            <path d="M350,106 C350,128 310,140 290,158" stroke="#34d399" stroke-width="1.5" fill="none" marker-end="url(#pg-arrow-green)" stroke-dasharray="5,3"/>
            <path d="M350,106 C350,128 350,140 370,158" stroke="#34d399" stroke-width="1.5" fill="none" marker-end="url(#pg-arrow-green)" stroke-dasharray="5,3"/>
            <path d="M350,106 C350,128 430,140 450,158" stroke="#34d399" stroke-width="1.5" fill="none" marker-end="url(#pg-arrow-green)" stroke-dasharray="5,3"/>

            <!-- Response arrow back -->
            <path d="M280,92 C230,92 210,100 162,100" stroke="#34d399" stroke-width="1.8" fill="none" marker-end="url(#pg-arrow-green)"/>
            <text x="219" y="114" text-anchor="middle" fill="#9ca3af" font-size="11">20 items + nextPage</text>

            <!-- Legend -->
            <rect x="170" y="240" width="360" height="76" rx="12" fill="#13151c" stroke="#2a2d3a" stroke-width="1"/>
            <text x="350" y="262" text-anchor="middle" fill="#9ca3af" font-size="12">Response payload:</text>
            <text x="350" y="282" text-anchor="middle" fill="#a5b4fc" font-size="11" font-family="monospace">{ "data": [...20 items], "page": 1, "totalPages": 50,</text>
            <text x="350" y="300" text-anchor="middle" fill="#a5b4fc" font-size="11" font-family="monospace">  "nextPage": "/items?page=2" }</text>
          </svg>
        </div>

        <ol class="steps">
          <li>
            <span class="step-num">1</span>
            <span>Client 發送 request 並帶上 page number 同 page size 參數（例如 <code>?page=1&amp;size=20</code>）</span>
          </li>
          <li>
            <span class="step-num">2</span>
            <span>API Server 收到後，將參數轉換成 SQL query 嘅 LIMIT 同 OFFSET，只從 Database 讀取指定範圍嘅 record</span>
          </li>
          <li>
            <span class="step-num">3</span>
            <span>Server 回傳嗰一頁嘅數據，連同 metadata（例如總頁數、下一頁嘅 link）一齊送返畀 Client</span>
          </li>
          <li>
            <span class="step-num">4</span>
            <span>Client 需要更多數據嘅時候，再 request 下一頁 — 重複以上流程</span>
          </li>
        </ol>

        <div class="key-points">
          <div class="key-point">
            <h4>Offset-based Pagination</h4>
            <p>用 page number + page size 做參數。實現簡單，但當數據量好大嘅時候，<code>OFFSET</code> 值越大 query 越慢，因為 database 要 skip 大量 row。</p>
          </div>
          <div class="key-point">
            <h4>Cursor-based Pagination</h4>
            <p>用上一頁最後一條 record 嘅 ID 做 cursor，query 直接從嗰個位置開始。效能穩定，適合大量數據同 real-time feed 場景。</p>
          </div>
          <div class="key-point">
            <h4>Response 結構</h4>
            <p>標準做法係喺 response 入面包含 <code>nextPage</code>、<code>totalItems</code>、<code>hasMore</code> 等 metadata，等 client 知道仲有冇數據。</p>
          </div>
          <div class="key-point">
            <h4>適用場景</h4>
            <p>搜尋結果、列表頁面、歷史紀錄 — 任何需要逐步載入大量 record 嘅 API endpoint 都適合用 Pagination。</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== TAB 2: COMPRESSION ==================== -->
    <div id="compression" class="tab-content">
      <div class="card">
        <h2>Compression 數據壓縮</h2>
        <div class="subtitle">壓縮之後先傳輸，大幅減少網絡 bandwidth 消耗</div>
        <p>
          概念同壓縮檔案再 send email 一模一樣。喺 server 端將 response body 壓縮之後先傳送畀 client，
          client 收到之後再解壓。特別係 JSON response 呢類文字數據，壓縮率可以去到 70-90%，
          效果非常顯著。
        </p>
        <p>
          關鍵在於 HTTP 本身就內建咗壓縮機制 — client 喺 request header 加 <code>Accept-Encoding: gzip, br</code>，
          server 就知道 client 支援邊種壓縮格式，然後用對應嘅演算法壓縮 response，
          再喺 response header 加 <code>Content-Encoding: gzip</code> 話畀 client 知。
        </p>

        <div class="diagram-container">
          <svg viewBox="0 0 700 320" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="cp-client-grad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#6366f1" stop-opacity="0.4"/>
                <stop offset="100%" stop-color="#1e293b"/>
              </linearGradient>
              <linearGradient id="cp-server-grad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#10B981" stop-opacity="0.4"/>
                <stop offset="100%" stop-color="#1e293b"/>
              </linearGradient>
              <linearGradient id="cp-big-grad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#f87171" stop-opacity="0.35"/>
                <stop offset="100%" stop-color="#1e293b"/>
              </linearGradient>
              <linearGradient id="cp-small-grad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#34d399" stop-opacity="0.4"/>
                <stop offset="100%" stop-color="#1e293b"/>
              </linearGradient>
              <filter id="cp-glow-green">
                <feGaussianBlur stdDeviation="4" result="blur"/>
                <feFlood flood-color="#10B981" flood-opacity="0.35" result="color"/>
                <feComposite in="color" in2="blur" operator="in" result="glow"/>
                <feMerge>
                  <feMergeNode in="glow"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
              <filter id="cp-shadow">
                <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.4"/>
              </filter>
              <marker id="cp-arrow-blue" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
                <polygon points="0 0, 10 3.5, 0 7" fill="#6366f1"/>
              </marker>
              <marker id="cp-arrow-green" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
                <polygon points="0 0, 10 3.5, 0 7" fill="#34d399"/>
              </marker>
            </defs>

            <!-- Client -->
            <rect x="30" y="60" width="130" height="56" rx="14" fill="url(#cp-client-grad)" stroke="#6366f1" stroke-width="1.5" filter="url(#cp-shadow)"/>
            <text x="95" y="85" text-anchor="middle" fill="#e0e0e0" font-size="13" font-weight="600">Client</text>
            <text x="95" y="102" text-anchor="middle" fill="#9ca3af" font-size="10">(Browser / App)</text>

            <!-- Server -->
            <rect x="490" y="60" width="160" height="56" rx="14" fill="url(#cp-server-grad)" stroke="#10B981" stroke-width="1.5" filter="url(#cp-glow-green)"/>
            <text x="570" y="85" text-anchor="middle" fill="#e0e0e0" font-size="13" font-weight="600">API Server</text>
            <text x="570" y="102" text-anchor="middle" fill="#9ca3af" font-size="10">(gzip / brotli)</text>

            <!-- Request arrow -->
            <path d="M160,72 C260,72 340,72 488,72" stroke="#6366f1" stroke-width="1.8" fill="none" marker-end="url(#cp-arrow-blue)"/>
            <text x="325" y="62" text-anchor="middle" fill="#a5b4fc" font-size="11">Accept-Encoding: gzip, br</text>

            <!-- Original size box -->
            <rect x="310" y="140" width="140" height="50" rx="14" fill="url(#cp-big-grad)" stroke="#f87171" stroke-width="1" filter="url(#cp-shadow)"/>
            <text x="380" y="162" text-anchor="middle" fill="#f87171" font-size="12" font-weight="600">Original: 2.5 MB</text>
            <text x="380" y="179" text-anchor="middle" fill="#9ca3af" font-size="10">Raw JSON response</text>

            <!-- Compressed size box -->
            <rect x="310" y="210" width="140" height="50" rx="14" fill="url(#cp-small-grad)" stroke="#34d399" stroke-width="1" filter="url(#cp-shadow)"/>
            <text x="380" y="232" text-anchor="middle" fill="#34d399" font-size="12" font-weight="600">Compressed: 250 KB</text>
            <text x="380" y="249" text-anchor="middle" fill="#9ca3af" font-size="10">gzip compressed</text>

            <!-- Reduction arrow -->
            <path d="M380,190 L380,208" stroke="#fbbf24" stroke-width="2" fill="none" marker-end="url(#cp-arrow-green)"/>
            <text x="435" y="204" fill="#fbbf24" font-size="11" font-weight="600">-90%</text>

            <!-- Response arrow (compressed) -->
            <path d="M490,100 C380,100 270,130 162,100" stroke="#34d399" stroke-width="2.5" fill="none" marker-end="url(#cp-arrow-green)"/>
            <text x="325" y="120" text-anchor="middle" fill="#34d399" font-size="11" font-weight="500">Content-Encoding: gzip (250 KB)</text>

            <!-- Legend -->
            <rect x="100" y="270" width="500" height="36" rx="10" fill="#13151c" stroke="#2a2d3a" stroke-width="1"/>
            <circle cx="150" cy="288" r="6" fill="#f87171"/>
            <text x="165" y="292" fill="#9ca3af" font-size="11">未壓縮 (2.5 MB)</text>
            <circle cx="320" cy="288" r="6" fill="#34d399"/>
            <text x="335" y="292" fill="#9ca3af" font-size="11">壓縮後 (250 KB)</text>
            <text x="500" y="292" fill="#fbbf24" font-size="11" font-weight="600">節省 90% bandwidth</text>
          </svg>
        </div>

        <ol class="steps">
          <li>
            <span class="step-num">1</span>
            <span>Client 發送 request 時，喺 header 加入 <code>Accept-Encoding: gzip, br</code>，表示支援壓縮格式</span>
          </li>
          <li>
            <span class="step-num">2</span>
            <span>Server 生成 response 之後，用 gzip 或 brotli 演算法壓縮 response body</span>
          </li>
          <li>
            <span class="step-num">3</span>
            <span>壓縮後嘅數據連同 <code>Content-Encoding</code> header 一齊傳返畀 Client</span>
          </li>
          <li>
            <span class="step-num">4</span>
            <span>Client（browser 或 HTTP library）自動根據 header 解壓數據，應用層面完全透明</span>
          </li>
        </ol>

        <div class="key-points">
          <div class="key-point">
            <h4>gzip</h4>
            <p>最普及嘅 HTTP 壓縮格式，幾乎所有 browser 同 server 都支援。壓縮率高，CPU 開銷合理，適合大部分場景。</p>
          </div>
          <div class="key-point">
            <h4>Brotli (br)</h4>
            <p>Google 開發嘅較新壓縮演算法，壓縮率比 gzip 高 15-25%。壓縮速度稍慢，但解壓速度快，適合靜態資源。</p>
          </div>
          <div class="key-point">
            <h4>適用範圍</h4>
            <p>文字類數據（JSON、HTML、CSV）壓縮效果最好。圖片、影片等已經壓縮過嘅 binary 數據再壓縮收效甚微。</p>
          </div>
          <div class="key-point">
            <h4>注意事項</h4>
            <p>壓縮會消耗 server CPU，高流量場景建議用 reverse proxy（如 Nginx）負責壓縮，避免 application server 負擔過重。</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== TAB 3: S3 OFFLOADING ==================== -->
    <div id="offload" class="tab-content">
      <div class="card">
        <h2>S3 Offloading 卸載到 Object Storage</h2>
        <div class="subtitle">當壓縮都唔夠用，將數據上傳到 S3 再畀 client 自己下載</div>
        <p>
          有時候就算做咗 Compression，response 依然太大。例如要匯出幾十萬行嘅報表、大型 CSV 檔案，
          又或者 response payload 達到幾百 MB。呢種情況下，直接透過 API response 傳輸數據會好慢，
          而且容易 timeout。
        </p>
        <p>
          常見嘅做法係：server 將數據生成好之後上傳到 S3（或者其他 Object Storage），然後只回傳一個
          pre-signed download URL 畀 client。咁樣 API server 唔使自己管理大檔案嘅傳輸，
          由 S3 嘅 CDN 基礎設施去處理。重點係將「生成數據」同「傳輸數據」兩個責任分開。
        </p>

        <div class="diagram-container">
          <svg viewBox="0 0 700 380" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="s3-client-grad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#6366f1" stop-opacity="0.4"/>
                <stop offset="100%" stop-color="#1e293b"/>
              </linearGradient>
              <linearGradient id="s3-api-grad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#10B981" stop-opacity="0.4"/>
                <stop offset="100%" stop-color="#1e293b"/>
              </linearGradient>
              <linearGradient id="s3-db-grad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#f59e0b" stop-opacity="0.4"/>
                <stop offset="100%" stop-color="#1e293b"/>
              </linearGradient>
              <linearGradient id="s3-bucket-grad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#f87171" stop-opacity="0.35"/>
                <stop offset="100%" stop-color="#1e293b"/>
              </linearGradient>
              <filter id="s3-glow">
                <feGaussianBlur stdDeviation="4" result="blur"/>
                <feFlood flood-color="#f59e0b" flood-opacity="0.35" result="color"/>
                <feComposite in="color" in2="blur" operator="in" result="glow"/>
                <feMerge>
                  <feMergeNode in="glow"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
              <filter id="s3-shadow">
                <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.4"/>
              </filter>
              <marker id="s3-arrow-blue" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
                <polygon points="0 0, 10 3.5, 0 7" fill="#6366f1"/>
              </marker>
              <marker id="s3-arrow-green" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
                <polygon points="0 0, 10 3.5, 0 7" fill="#34d399"/>
              </marker>
              <marker id="s3-arrow-amber" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
                <polygon points="0 0, 10 3.5, 0 7" fill="#fbbf24"/>
              </marker>
              <marker id="s3-arrow-red" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
                <polygon points="0 0, 10 3.5, 0 7" fill="#f87171"/>
              </marker>
            </defs>

            <!-- Client -->
            <rect x="30" y="40" width="130" height="56" rx="14" fill="url(#s3-client-grad)" stroke="#6366f1" stroke-width="1.5" filter="url(#s3-shadow)"/>
            <text x="95" y="65" text-anchor="middle" fill="#e0e0e0" font-size="13" font-weight="600">Client</text>
            <text x="95" y="82" text-anchor="middle" fill="#9ca3af" font-size="10">(Browser / App)</text>

            <!-- API Server -->
            <rect x="280" y="40" width="150" height="56" rx="14" fill="url(#s3-api-grad)" stroke="#10B981" stroke-width="1.5" filter="url(#s3-shadow)"/>
            <text x="355" y="65" text-anchor="middle" fill="#e0e0e0" font-size="13" font-weight="600">API Server</text>
            <text x="355" y="82" text-anchor="middle" fill="#9ca3af" font-size="10">(Generate data)</text>

            <!-- Database -->
            <rect x="530" y="40" width="130" height="56" rx="14" fill="url(#s3-db-grad)" stroke="#f59e0b" stroke-width="1.5" filter="url(#s3-shadow)"/>
            <text x="595" y="65" text-anchor="middle" fill="#e0e0e0" font-size="13" font-weight="600">Database</text>
            <text x="595" y="82" text-anchor="middle" fill="#9ca3af" font-size="10">(Source data)</text>

            <!-- S3 Bucket -->
            <rect x="280" y="180" width="150" height="62" rx="14" fill="url(#s3-bucket-grad)" stroke="#f87171" stroke-width="1.5" filter="url(#s3-glow)"/>
            <text x="355" y="205" text-anchor="middle" fill="#e0e0e0" font-size="13" font-weight="600">S3 Bucket</text>
            <text x="355" y="224" text-anchor="middle" fill="#9ca3af" font-size="10">(Object Storage)</text>

            <!-- Step 1: Client -> API -->
            <path d="M160,55 C210,55 230,55 278,55" stroke="#6366f1" stroke-width="1.8" fill="none" marker-end="url(#s3-arrow-blue)"/>
            <text x="219" y="47" text-anchor="middle" fill="#a5b4fc" font-size="10" font-weight="500">1. POST /export</text>

            <!-- Step 2: API -> Database -->
            <path d="M430,68 C470,68 500,68 528,68" stroke="#fbbf24" stroke-width="1.8" fill="none" marker-end="url(#s3-arrow-amber)"/>
            <text x="479" y="60" text-anchor="middle" fill="#fbbf24" font-size="10">2. Query data</text>

            <!-- Step 3: API -> S3 upload -->
            <path d="M355,96 C355,120 355,148 355,178" stroke="#f87171" stroke-width="1.8" fill="none" marker-end="url(#s3-arrow-red)"/>
            <text x="400" y="140" fill="#f87171" font-size="10" font-weight="500">3. Upload file</text>

            <!-- Step 4: API returns URL to Client -->
            <path d="M280,86 C220,110 180,100 162,86" stroke="#34d399" stroke-width="1.8" fill="none" marker-end="url(#s3-arrow-green)"/>
            <text x="200" y="116" text-anchor="middle" fill="#34d399" font-size="10">4. Return download URL</text>

            <!-- Step 5: Client downloads from S3 -->
            <path d="M95,96 C95,170 140,210 278,210" stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#s3-arrow-blue)" stroke-dasharray="6,3"/>
            <text x="150" y="195" fill="#a5b4fc" font-size="10" font-weight="500">5. Download from S3</text>

            <!-- Flow summary -->
            <rect x="70" y="275" width="560" height="85" rx="12" fill="#13151c" stroke="#2a2d3a" stroke-width="1"/>
            <text x="350" y="298" text-anchor="middle" fill="#ffffff" font-size="12" font-weight="600">Flow Summary</text>
            <text x="350" y="318" text-anchor="middle" fill="#a5b4fc" font-size="11" font-family="monospace">Client --request--> API --query--> DB</text>
            <text x="350" y="336" text-anchor="middle" fill="#f87171" font-size="11" font-family="monospace">API --upload--> S3 --url--> Client --download--> S3</text>
            <text x="350" y="352" text-anchor="middle" fill="#9ca3af" font-size="10">API server 唔使處理大檔案傳輸，由 S3 CDN 負責</text>
          </svg>
        </div>

        <ol class="steps">
          <li>
            <span class="step-num">1</span>
            <span>Client 發送匯出請求（例如 <code>POST /reports/export</code>）</span>
          </li>
          <li>
            <span class="step-num">2</span>
            <span>API Server 從 Database 查詢所需數據，生成完整嘅檔案（CSV、Excel、JSON 等）</span>
          </li>
          <li>
            <span class="step-num">3</span>
            <span>將生成好嘅檔案上傳到 S3 Bucket，取得一個 pre-signed URL（帶有過期時間同存取權限）</span>
          </li>
          <li>
            <span class="step-num">4</span>
            <span>API 只回傳 download URL 畀 Client — response payload 極細，通常只有幾百 bytes</span>
          </li>
          <li>
            <span class="step-num">5</span>
            <span>Client 用呢個 URL 直接從 S3 下載檔案，享受 S3 高速下載基礎設施嘅優勢</span>
          </li>
        </ol>

        <div class="key-points">
          <div class="key-point">
            <h4>Pre-signed URL</h4>
            <p>帶有簽名嘅臨時下載連結，設定過期時間（例如 15 分鐘），過期後就無法再存取。安全又方便。</p>
          </div>
          <div class="key-point">
            <h4>異步處理</h4>
            <p>如果數據生成耗時較長，可以先回傳 202 Accepted，然後用 polling 或 webhook 通知 client 下載連結。</p>
          </div>
          <div class="key-point">
            <h4>成本效益</h4>
            <p>S3 儲存同傳輸費用極低，而且自帶 CDN 能力，全球各地下載速度都快，比 API server 直傳划算得多。</p>
          </div>
          <div class="key-point">
            <h4>責任分離</h4>
            <p>API server 只負責「生成數據」，S3 負責「儲存同傳輸」。各司其職，server 唔會因為大檔案傳輸而 block。</p>
          </div>
        </div>

        <div class="use-case">
          <h4>部署建議</h4>
          <p>
            呢個 pattern 特別適合匯出報表、大型 CSV 下載、log 檔案匯出等場景。
            建議配合 Task Queue 使用 — client 發請求後立即收到 job ID，server 喺背景處理完再通知。
            S3 嘅 pre-signed URL 記得設定合理嘅過期時間，通常 15-60 分鐘已經足夠。
            同時亦建議設定 S3 lifecycle policy，自動清理過期嘅匯出檔案，避免儲存成本無限增長。
          </p>
        </div>
      </div>
    </div>

  </div>

  <script>
    const tabs = document.querySelectorAll('.tab-btn');
    const contents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab)?.classList.add('active');
      });
    });
  </script>
</body>
</html>
