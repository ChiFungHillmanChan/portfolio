class o{constructor(){this.gameState=null,this.playerId=null,this.gameCode=null,this.isHost=!1,this.listeners=new Set,this.pollInterval=null,this.lastKnownUpdate=0}generateGameCode(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let e="";for(let s=0;s<6;s++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}async createGame(t){const e=this.generateGameCode(),s={gameCode:e,hostId:t.id,players:[{...t,isHost:!0,isOnline:!0}],status:"lobby",currentQuestion:null,currentQuestionIndex:0,votes:{},questions:[],settings:{maxPlayers:10,maxQuestions:30},createdAt:Date.now(),lastUpdated:Date.now()};return localStorage.setItem(`nhie_game_${e}`,JSON.stringify(s)),this.gameCode=e,this.playerId=t.id,this.isHost=!0,this.gameState=s,this.startPolling(),s}async joinGame(t,e){const s=localStorage.getItem(`nhie_game_${t}`);if(!s)throw new Error("Game not found");const a=JSON.parse(s);if(a.status!=="lobby")throw new Error("Game has already started");if(a.players.length>=a.settings.maxPlayers)throw new Error("Game is full");if(a.players.find(i=>i.name.toLowerCase()===e.name.toLowerCase()))throw new Error("Player name already taken");return a.players.push({...e,isHost:!1,isOnline:!0}),a.lastUpdated=Date.now(),localStorage.setItem(`nhie_game_${t}`,JSON.stringify(a)),this.gameCode=t,this.playerId=e.id,this.isHost=!1,this.gameState=a,this.startPolling(),a}async startGame(t){if(!this.isHost)throw new Error("Only host can start the game");const e=t.slice(0,30);return this.gameState.status="playing",this.gameState.questions=e,this.gameState.currentQuestion=e[0],this.gameState.currentQuestionIndex=0,this.gameState.votes={},this.gameState.lastUpdated=Date.now(),localStorage.setItem(`nhie_game_${this.gameCode}`,JSON.stringify(this.gameState)),!0}async submitVote(t){if(this.gameState.votes&&this.gameState.votes[this.playerId])throw new Error("Already voted");return this.gameState.votes[this.playerId]={playerId:this.playerId,vote:t,timestamp:Date.now()},this.gameState.lastUpdated=Date.now(),localStorage.setItem(`nhie_game_${this.gameCode}`,JSON.stringify(this.gameState)),!0}async nextQuestion(){if(!this.isHost)throw new Error("Only host can advance questions");const t=this.gameState.currentQuestionIndex+1;if(t>=this.gameState.questions.length)throw this.gameState.status="finished",this.gameState.currentQuestion=null,new Error("Game finished");return this.gameState.currentQuestionIndex=t,this.gameState.currentQuestion=this.gameState.questions[t],this.gameState.votes={},this.gameState.lastUpdated=Date.now(),localStorage.setItem(`nhie_game_${this.gameCode}`,JSON.stringify(this.gameState)),!0}startPolling(){this.pollInterval||(this.pollInterval=setInterval(()=>{this.checkForUpdates()},1e3))}checkForUpdates(){if(!this.gameCode)return;const t=localStorage.getItem(`nhie_game_${this.gameCode}`);if(t){const e=JSON.parse(t);e.lastUpdated>this.lastKnownUpdate&&(this.lastKnownUpdate=e.lastUpdated,this.gameState=e,this.notifyListeners(e))}}stopPolling(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null)}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}notifyListeners(t){this.listeners.forEach(e=>{try{e(t)}catch(s){console.error("Listener error:",s)}})}getVotingResults(){if(!this.gameState||!this.gameState.votes)return{yes:0,no:0};const t=Object.values(this.gameState.votes);return{yes:t.filter(e=>e.vote==="yes").length,no:t.filter(e=>e.vote==="no").length}}isVotingComplete(){if(!this.gameState)return!1;const t=Object.keys(this.gameState.votes||{}).length,e=this.gameState.players.filter(s=>s.isOnline).length;return t===e}async leaveGame(){!this.gameCode||!this.playerId||(this.gameState&&(this.gameState.players=this.gameState.players.filter(t=>t.id!==this.playerId),this.isHost&&this.gameState.players.length>0&&(this.gameState.players[0].isHost=!0,this.gameState.hostId=this.gameState.players[0].id),this.gameState.players.length===0?localStorage.removeItem(`nhie_game_${this.gameCode}`):(this.gameState.lastUpdated=Date.now(),localStorage.setItem(`nhie_game_${this.gameCode}`,JSON.stringify(this.gameState)))),this.cleanup())}cleanup(){this.stopPolling(),this.gameState=null,this.playerId=null,this.gameCode=null,this.isHost=!1,this.listeners.clear()}}export{o as default};
